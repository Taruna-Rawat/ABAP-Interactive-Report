REPORT ZASG_4.

TYPE-POOLS: SLIS .

TABLES: VBAK, VBAP, LIKP, LIPS, VBRK, VBRP , KNA1.

TYPES:
*       SALES DOCUMENT: HEADER TABLE
          BEGIN OF TY_VBAK,
           VBELN TYPE VBAK-VBELN,
           ERNAM TYPE VBAK-ERNAM,
           BUKRS_VF TYPE VBAK-BUKRS_VF,
          END OF TY_VBAK,

*        SALES DOCUMENT: ITEM TABLE
           BEGIN OF TY_VBAP,
             VBELN TYPE VBAP-VBELN,
             MATNR TYPE VBAP-MATNR,
             MATWA TYPE VBAP-MATWA,
             PRODH TYPE VBAP-PRODH,
           END OF TY_VBAP,

*        BILLING DOCUMENT: ITEM TABLE
         BEGIN OF TY_VBRP,
           AUBEL TYPE VBRP-AUBEL,
           VBELN TYPE VBRP-VBELN,
           VGBEL TYPE VBRP-VGBEL,
           NTGEW TYPE VBRP-NTGEW,
         END OF TY_VBRP,

*        BILLING DOCUMENT: HEADER TABLE
         BEGIN OF TY_VBRK,
           VBRK_VBELN TYPE VBRK-VBELN,
           BELNR TYPE VBRK-BELNR,
           ZTERM TYPE VBRK-ZTERM,
         END OF TY_VBRK,

*        SD DOCUMENT - DELIVERY : ITEM TABLE
         BEGIN OF TY_LIPS,
           LIPS_VGBEL TYPE LIPS-VGBEL,
           POSNR TYPE LIPS-POSNR,
           WERKS TYPE LIPS-WERKS,
           LIPS_VBELN TYPE LIPS-VBELN,
         END OF TY_LIPS,

*        SD DOCUMENT - DELIVERY : HEADER TABLE
         BEGIN OF TY_LIKP,
           LIKP_VBELN TYPE LIKP-VBELN,
           LGNUM TYPE LIKP-LGNUM,
           LFDAT TYPE LIKP-LFDAT,
           LIKP_KUNNR TYPE LIKP-KUNNR,
         END OF TY_LIKP,

*         GENERAL DATA IN CUSTOMER MASTER
         BEGIN OF TY_KNA1,
           KNA1_KUNNR TYPE KNA1-KUNNR,
           NAME1 TYPE KNA1-NAME1,
           ADRNR TYPE KNA1-ADRNR,
           ERDAT TYPE KNA1-ERDAT,
         END OF TY_KNA1,

*        FINAL TABLE
         BEGIN OF TY_FINAL,
           VBELN TYPE VBAK-VBELN,
           ERNAM TYPE VBAK-ERNAM,
           BUKRS_VF TYPE VBAK-BUKRS_VF,
           MATNR TYPE VBAP-MATNR,
           MATWA TYPE VBAP-MATWA,
           PRODH TYPE VBAP-PRODH,
           VBELN1 TYPE VBRP-VBELN,
           VGBEL TYPE VBRP-VGBEL,
           NTGEW TYPE VBRP-NTGEW,
           BELNR TYPE VBRK-BELNR,
           ZTERM TYPE VBRK-ZTERM,
           POSNR TYPE LIPS-POSNR,
           WERKS TYPE LIPS-WERKS,
           LIPS_VBELN TYPE LIPS-VBELN,
           LGNUM TYPE LIKP-LGNUM,
           LFDAT TYPE LIKP-LFDAT,
           LIKP_KUNNR TYPE LIKP-KUNNR,
           NAME1 TYPE KNA1-NAME1,
           ADRNR TYPE KNA1-ADRNR,
           ERDAT TYPE KNA1-ERDAT,

         END OF TY_FINAL .

DATA: IT_VBAK TYPE STANDARD TABLE OF TY_VBAK,
      WA_VBAK TYPE TY_VBAK,
      IT_VBAP TYPE STANDARD TABLE OF TY_VBAP,
      WA_VBAP TYPE TY_VBAP,
      IT_LIKP TYPE STANDARD TABLE OF TY_LIKP,
      WA_LIKP TYPE TY_LIKP,
      IT_LIPS TYPE STANDARD TABLE OF TY_LIPS,
      WA_LIPS TYPE TY_LIPS,
      IT_VBRK TYPE STANDARD TABLE OF TY_VBRK,
      WA_VBRK TYPE TY_VBRK,
      IT_VBRP TYPE STANDARD TABLE OF TY_VBRP,
      WA_VBRP TYPE TY_VBRP ,
      IT_KNA1 TYPE STANDARD TABLE OF TY_KNA1,
      WA_KNA1 TYPE TY_KNA1 ,
      IT_FINAL TYPE STANDARD TABLE OF TY_FINAL,
      WA_FINAL TYPE TY_FINAL,
      IT_FCAT TYPE SLIS_T_FIELDCAT_ALV,
      WA_FCAT LIKE LINE OF IT_FCAT.

SELECTION-SCREEN BEGIN OF BLOCK BLOCK_1 WITH FRAME TITLE BLOCK_1.
  SELECT-OPTIONS: SALES FOR VBAK-VBELN,
                  BILL FOR VBRP-VBELN.
*                  S_BILL FOR VBRP-VGBEL.
SELECTION-SCREEN END OF BLOCK BLOCK_1 .

START-OF-SELECTION.
PERFORM GET_DATA.
PERFORM CREATE_FIELDCAT.
PERFORM FINAL_TABLE.
PERFORM DISPLAY_DATA.
END-OF-SELECTION.

FORM GET_DATA.

    IF SALES IS NOT INITIAL.
    SELECT VBELN ERNAM BUKRS_VF FROM VBAK INTO TABLE IT_VBAK UP TO 50 ROWS
                                     WHERE VBELN EQ SALES .
    ELSE .
    SELECT VBELN ERNAM BUKRS_VF FROM VBAK INTO TABLE IT_VBAK UP TO 50 ROWS
                                    WHERE VBELN NE ''.
    ENDIF .

    IF IT_VBAK IS NOT INITIAL .
    SELECT VBELN MATNR MATWA PRODH FROM VBAP INTO TABLE IT_VBAP
                                      FOR ALL ENTRIES IN IT_VBAK
                                      WHERE VBELN = IT_VBAK-VBELN.



     SELECT AUBEL VBELN VGBEL NTGEW FROM VBRP INTO TABLE IT_VBRP
                                       FOR ALL ENTRIES IN IT_VBAP
                                       WHERE AUBEL = IT_VBAP-VBELN .
***    SELECT VBELN BELNR ZTERM FROM VBRK INTO TABLE IT_VBRK
***                                       FOR ALL ENTRIES IN IT_VBRP
***                                       WHERE VBELN = IT_VBRP-VBRP_VBELN AND VBELN EQ BILL AND VBELN NE ''.
***    SELECT VGBEL POSNR WERKS VBELN FROM LIPS INTO TABLE IT_LIPS
***                                       FOR ALL ENTRIES IN IT_VBRP
***                                       WHERE VGBEL = IT_VBRP-VBRP_VGBEL.
***    SELECT VBELN LGNUM LFDAT KUNNR FROM LIKP INTO TABLE IT_LIKP
***                                      FOR ALL ENTRIES IN IT_LIPS
***                                      WHERE VBELN = IT_LIPS-LIPS_VBELN.
***    SELECT KUNNR NAME1 ADRNR ERDAT FROM KNA1 INTO TABLE IT_KNA1
***                                       FOR ALL ENTRIES IN IT_LIKP
***                                       WHERE KUNNR = IT_LIKP-LIKP_KUNNR.
   ENDIF.
ENDFORM.


FORM CREATE_FIELDCAT.
  WA_FCAT-COL_POS = '1'.
  WA_FCAT-FIELDNAME = 'VBELN'.
  WA_FCAT-SELTEXT_M = 'SALES DOCUMENT'.
  WA_FCAT-KEY = 'X'.
  APPEND WA_FCAT TO IT_FCAT.
  CLEAR WA_FCAT.

  WA_FCAT-COL_POS = '2'.
  WA_FCAT-FIELDNAME = 'ERNAM'.
  WA_FCAT-SELTEXT_M = 'CREATED BY'.
  WA_FCAT-KEY = 'X'.
  APPEND WA_FCAT TO IT_FCAT.
  CLEAR WA_FCAT.

  WA_FCAT-COL_POS = '3'.
  WA_FCAT-FIELDNAME = 'BUKRS_VF'.
  WA_FCAT-SELTEXT_M = 'COMPANY CODE'.
  WA_FCAT-KEY = 'X'.
  APPEND WA_FCAT TO IT_FCAT.
  CLEAR WA_FCAT.

  WA_FCAT-COL_POS = '4'.
  WA_FCAT-FIELDNAME = 'MATNR'.
  WA_FCAT-TABNAME = 'IT_VBAP'.
  WA_FCAT-REF_FIELDNAME = 'MATNR'.
  WA_FCAT-REF_TABNAME = 'VBAP'.
  APPEND WA_FCAT TO IT_FCAT.
  CLEAR WA_FCAT.

  WA_FCAT-COL_POS = '5'.
  WA_FCAT-FIELDNAME = 'MATWA'.
  WA_FCAT-TABNAME = 'IT_VBAP'.
  WA_FCAT-REF_FIELDNAME = 'MATWA'.
  WA_FCAT-REF_TABNAME = 'VBAP'.
  APPEND WA_FCAT TO IT_FCAT.
  CLEAR WA_FCAT.

  WA_FCAT-COL_POS = '6'.
  WA_FCAT-FIELDNAME = 'PRODH'.
  WA_FCAT-TABNAME = 'IT_VBAP'.
  WA_FCAT-REF_FIELDNAME = 'PRODH'.
  WA_FCAT-REF_TABNAME = 'VBAP'.
  APPEND WA_FCAT TO IT_FCAT.
  CLEAR WA_FCAT.
*
  WA_FCAT-COL_POS = '7'.
  WA_FCAT-FIELDNAME = 'VBELN1'.
  WA_FCAT-TABNAME = 'IT_VBRP'.
  WA_FCAT-REF_FIELDNAME = 'VBELN'.
  WA_FCAT-REF_TABNAME = 'VBRP'.
  APPEND WA_FCAT TO IT_FCAT.
  CLEAR WA_FCAT.

  WA_FCAT-COL_POS = '8'.
  WA_FCAT-FIELDNAME = 'VGBEL'.
  WA_FCAT-TABNAME = 'IT_VBRP'.
  WA_FCAT-REF_FIELDNAME = 'VGBEL'.
  WA_FCAT-REF_TABNAME = 'VBRP'.
  APPEND WA_FCAT TO IT_FCAT.
  CLEAR WA_FCAT.
*
  WA_FCAT-COL_POS = '9'.
  WA_FCAT-FIELDNAME = 'NTGEW'.
  WA_FCAT-TABNAME = 'IT_VBRP'.
  WA_FCAT-REF_FIELDNAME = 'NTGEW'.
  WA_FCAT-REF_TABNAME = 'VBRP'.
  APPEND WA_FCAT TO IT_FCAT.
  CLEAR WA_FCAT.
*
*  WA_FCAT-COL_POS = '10'.
*  WA_FCAT-FIELDNAME = 'BELNR'.
*  WA_FCAT-TABNAME = 'IT_VBRK'.
*  WA_FCAT-REF_FIELDNAME = 'BELNR'.
*  WA_FCAT-REF_TABNAME = 'VBRK'.
*  APPEND WA_FCAT TO IT_FCAT.
*  CLEAR WA_FCAT.
*
*  WA_FCAT-COL_POS = '11'.
*  WA_FCAT-FIELDNAME = 'ZTERM'.
*  WA_FCAT-TABNAME = 'IT_VBRK'.
*  WA_FCAT-REF_FIELDNAME = 'ZTERM'.
*  WA_FCAT-REF_TABNAME = 'VBRK'.
*  APPEND WA_FCAT TO IT_FCAT.
*  CLEAR WA_FCAT.
*
*  WA_FCAT-COL_POS = '12'.
*  WA_FCAT-FIELDNAME = 'POSNR'.
*  WA_FCAT-TABNAME = 'IT_LIPS'.
*  WA_FCAT-REF_FIELDNAME = 'POSNR'.
*  WA_FCAT-REF_TABNAME = 'LIPS'.
*  APPEND WA_FCAT TO IT_FCAT.
*  CLEAR WA_FCAT.
*
*  WA_FCAT-COL_POS = '13'.
*  WA_FCAT-FIELDNAME = 'WERKS'.
*  WA_FCAT-TABNAME = 'IT_LIPS'.
*  WA_FCAT-REF_FIELDNAME = 'WERKS'.
*  WA_FCAT-REF_TABNAME = 'LIPS'.
*  APPEND WA_FCAT TO IT_FCAT.
*  CLEAR WA_FCAT.
*
*  WA_FCAT-COL_POS = '14'.
*  WA_FCAT-FIELDNAME = 'LIPS_VBELN'.
*  WA_FCAT-TABNAME = 'IT_LIPS'.
*  WA_FCAT-REF_FIELDNAME = 'LIPS_VBELN'.
*  WA_FCAT-REF_TABNAME = 'LIPS'.
*  APPEND WA_FCAT TO IT_FCAT.
*  CLEAR WA_FCAT.
*
*  WA_FCAT-COL_POS = '15'.
*  WA_FCAT-FIELDNAME = 'LGNUM'.
*  WA_FCAT-TABNAME = 'IT_LIKP'.
*  WA_FCAT-REF_FIELDNAME = 'LGNUM'.
*  WA_FCAT-REF_TABNAME = 'LIKP'.
*  APPEND WA_FCAT TO IT_FCAT.
*  CLEAR WA_FCAT.
*
*  WA_FCAT-COL_POS = '16'.
*  WA_FCAT-FIELDNAME = 'LFDAT'.
*  WA_FCAT-TABNAME = 'IT_LIKP'.
*  WA_FCAT-REF_FIELDNAME = 'LFDAT'.
*  WA_FCAT-REF_TABNAME = 'LIKP'.
*  APPEND WA_FCAT TO IT_FCAT.
*  CLEAR WA_FCAT.
*
*  WA_FCAT-COL_POS = '17'.
*  WA_FCAT-FIELDNAME = 'LIKP_KUNNR'.
*  WA_FCAT-TABNAME = 'IT_LIKP'.
*  WA_FCAT-REF_FIELDNAME = 'LIKP_KUNNR'.
*  WA_FCAT-REF_TABNAME = 'LIKP'.
*  APPEND WA_FCAT TO IT_FCAT.
*  CLEAR WA_FCAT.
*
*  WA_FCAT-COL_POS = '18'.
*  WA_FCAT-FIELDNAME = 'NAME1'.
*  WA_FCAT-TABNAME = 'IT_KNA1'.
*  WA_FCAT-REF_FIELDNAME = 'NAME1'.
*  WA_FCAT-REF_TABNAME = 'KNA1'.
*  APPEND WA_FCAT TO IT_FCAT.
*  CLEAR WA_FCAT.
*
*  WA_FCAT-COL_POS = '19'.
*  WA_FCAT-FIELDNAME = 'ADRNR'.
*  WA_FCAT-TABNAME = 'IT_KNA1'.
*  WA_FCAT-REF_FIELDNAME = 'ADRNR'.
*  WA_FCAT-REF_TABNAME = 'KNA1'.
*  APPEND WA_FCAT TO IT_FCAT.
*  CLEAR WA_FCAT.
*
*  WA_FCAT-COL_POS = '20'.
*  WA_FCAT-FIELDNAME = 'ERDAT'.
*  WA_FCAT-TABNAME = 'IT_KNA1'.
*  WA_FCAT-REF_FIELDNAME = 'ERDAT'.
*  WA_FCAT-REF_TABNAME = 'KNA1'.
*  APPEND WA_FCAT TO IT_FCAT.
*  CLEAR WA_FCAT.
ENDFORM.

FORM DISPLAY_DATA.
  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
   EXPORTING
     I_CALLBACK_PROGRAM                = 'SY-REPID'
     I_CALLBACK_USER_COMMAND           = 'UCOMMAND'
     IT_FIELDCAT                       = IT_FCAT
    TABLES
      T_OUTTAB                          = IT_FINAL .
ENDFORM.


FORM FINAL_TABLE.
LOOP AT IT_VBAK INTO WA_VBAK .

    WA_FINAL-VBELN = WA_VBAK-VBELN.
    WA_FINAL-ERNAM = WA_VBAK-ERNAM.
    WA_FINAL-BUKRS_VF = WA_VBAK-BUKRS_VF.

    READ TABLE IT_VBAP INTO WA_VBAP WITH KEY VBELN = WA_FINAL-VBELN.
    IF SY-SUBRC = 0.
      WA_FINAL-MATNR = WA_VBAP-MATNR.
      WA_FINAL-MATWA = WA_VBAP-MATWA.
      WA_FINAL-PRODH = WA_VBAP-PRODH.
    ENDIF.
**
    READ TABLE IT_VBRP INTO WA_VBRP WITH KEY AUBEL = WA_FINAL-VBELN.
    IF SY-SUBRC = 0.
      WA_FINAL-VBELN1 = WA_VBRP-VBELN.
      WA_FINAL-VGBEL = WA_VBRP-VGBEL.
      WA_FINAL-NTGEW = WA_VBRP-NTGEW.
    ENDIF.
**
**    READ TABLE IT_VBRK INTO WA_VBRK WITH KEY VBRK_VBELN = WA_FINAL-VBRP_VBELN.
**    IF SY-SUBRC = 0.
**      WA_FINAL-BELNR = WA_VBRK-BELNR.
**      WA_FINAL-ZTERM = WA_VBRK-ZTERM.
**    ENDIF.
**
**  READ TABLE IT_LIPS INTO WA_LIPS WITH KEY LIPS_VGBEL = WA_FINAL-VBRP_VGBEL.
**    IF SY-SUBRC = 0 .
**      WA_FINAL-LIPS_VBELN = WA_LIPS-LIPS_VBELN.
**      WA_FINAL-POSNR = WA_LIPS-POSNR.
**      WA_FINAL-WERKS = WA_LIPS-WERKS.
**    ENDIF.
**
**  READ TABLE IT_LIKP INTO WA_LIKP WITH KEY LIKP_VBELN = WA_FINAL-LIPS_VBELN.
**  IF SY-SUBRC = 0.
**    WA_FINAL-LGNUM = WA_LIKP-LGNUM.
**    WA_FINAL-LFDAT = WA_LIKP-LFDAT.
**    WA_FINAL-LIKP_KUNNR = WA_LIKP-LIKP_KUNNR.
**  ENDIF.
**
**  READ TABLE IT_KNA1 INTO WA_KNA1 WITH KEY KNA1_KUNNR = WA_FINAL-LIKP_KUNNR.
**  IF SY-SUBRC = 0.
**    WA_FINAL-NAME1 = WA_KNA1-NAME1.
**    WA_FINAL-ADRNR = WA_KNA1-ADRNR.
**  ENDIF.

  APPEND WA_FINAL TO IT_FINAL.
  CLEAR WA_FINAL.
*  MODIFY IT_FINAL FROM WA_FINAL .
*  CLEAR WA_FINAL .
  ENDLOOP.
ENDFORM.

FORM UCOMMAND USING R_UCOMM TYPE SY-UCOMM R_SELFIELD TYPE SLIS_SELFIELD.

    IF R_SELFIELD-FIELDNAME = 'VBELN'.
    MESSAGE : R_SELFIELD-VALUE TYPE 'I'.
    ENDIF.

    IF R_SELFIELD-FIELDNAME = 'ERNAM'.
      MESSAGE : R_SELFIELD-VALUE TYPE 'I'.
    ENDIF.

    IF R_SELFIELD-FIELDNAME = 'BUKRS_VF'.
      MESSAGE : R_SELFIELD-VALUE TYPE 'I'.
    ENDIF.
ENDFORM.
